---
import { themeConfig } from '@/config'

const { highlight } = themeConfig.color.light
---

<div class="max-w-full mx-left rounded-lg p-6">
  <form id="contact-form" action="/api/contact/" novalidate style={`--highlight-color: ${highlight}`}>
    <div class="mb-4">
      <label for="full-name" class="block font-form mb-2">
        Nom <span class="text-warning">*</span>
      </label>
      <input
        class="w-full py-2 pr-3 border-0 border-b-1 bg-transparent focus:outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed form-input"
        id="full-name"
        type="text"
        name="fullName"
        placeholder="Char René"
        required
      />
      <span class="text-warning text-sm mt-1 hidden" data-error="full-name"></span>
    </div>

    <div class="mb-4">
      <label for="email" class="block font-form mb-2">
        E-mail <span class="text-warning">*</span>
      </label>
      <input
        class="w-full py-2 pr-3 border-0 border-b-1 bg-transparent focus:outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed form-input"
        id="email"
        type="email"
        name="email"
        placeholder="rchar@poesie.fr"
        required
      />
      <span class="text-warning text-sm mt-1 hidden" data-error="email"></span>
    </div>

    <div class="mb-4">
      <label for="message" class="block font-form mb-2">
        Message
      </label>
      <textarea
        class="w-full py-2 pr-3 border-0 border-b-1 bg-transparent focus:outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed resize-none form-input"
        id="message"
        name="message"
        rows="4"
        placeholder="Écrivez-moi"
      ></textarea>
      <span class="text-warning text-sm mt-1 hidden" data-error="message"></span>
    </div>

    <div class="mb-4">
      <label for="newsletter-consent" class="flex items-center gap-2 cursor-pointer border-0 pb-3">
        <input
          class="form-checkbox"
          id="newsletter-consent"
          type="checkbox"
          name="newsletterConsent"
        />
        <span class="font-form text-xs align-text-bottom">
          Je souhaite recevoir la newsletter
        </span>
      </label>
      <span class="text-warning text-sm mt-1 hidden" data-error="newsletter-consent"></span>
    </div>

    <div class="mb-4">
      <label for="consent" class="flex items-center gap-2 cursor-pointer border-0 pb-3">
        <input
          class="form-checkbox"
          id="consent"
          type="checkbox"
          name="consent"
          required
        />
        <span class="font-form text-xs align-text-bottom">
          J'accepte que mes données soient conservées pour traiter ma demande <span class="text-warning">*</span>
        </span>
      </label>
      <span class="text-warning text-sm mt-1 hidden" data-error="consent"></span>
    </div>

    <div class="mb-4">
      <button
        type="submit"
        class="font-italic font-bold highlight-hover pt-2 pb-.2 px-1 after:bottom-0.35em border-0 bg-transparent text-left font-form focus:outline-none transition-colors"
      >
        Envoyer
      </button>
    </div>

    <div
      id="form-error"
      class="hidden rounded-lg border border-red-200 bg-red-50 p-4 text-red-800 mt-4"
      role="alert"
    >
      <p class="font-semibold">⚠ Une erreur est survenue</p>
      <p class="text-sm" id="error-message">Veuillez réessayer plus tard.</p>
    </div>

    <div
      id="form-success"
      class="hidden rounded-lg border border-green-200 bg-green-50 p-4 text-green-800 mt-4"
      role="alert"
    >
      <p class="font-semibold">✓ Message envoyé avec succès</p>
      <p class="text-sm">Nous vous répondrons dans les plus brefs délais.</p>
    </div>
  </form>
</div>

<style>
  /* Form inputs focus state */
  .form-input:focus {
    border-color: var(--highlight-color);
  }

  /* Checkbox styling */
  .form-checkbox {
    appearance: none;
    width: 1rem;
    height: 1rem;
    border: 1px solid currentColor;
    border-radius: 0;
    background-color: transparent;
    cursor: pointer;
    transition: all 150ms ease-out;
  }

  .form-checkbox:hover:not(:disabled) {
    border-color: var(--highlight-color);
  }

  .form-checkbox:checked {
    background-color: var(--highlight-color);
    border-color: var(--highlight-color);
    background-image: url("../../assets/icons/copy-check.svg");
    background-repeat: no-repeat;
    background-position: center;
    background-size: 76%;
  }

  .form-checkbox:focus-visible {
    outline: 2px solid var(--highlight-color);
    outline-offset: 2px;
  }

  .form-checkbox:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>

<script>
import { getBotpoisonSolution } from "@/utils/botpoisonUtils";

const form = document.getElementById('contact-form') as HTMLFormElement;
const formError = document.getElementById('form-error') as HTMLDivElement;
const errorMessage = document.getElementById('error-message') as HTMLParagraphElement;
const formSuccess = document.getElementById('form-success') as HTMLDivElement;
const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;

// Validation helper functions
function validateEmail(email: string): boolean {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

function showError(fieldId: string, message: string) {
  const errorSpan = form.querySelector(`[data-error="${fieldId}"]`) as HTMLSpanElement;
  if (errorSpan) {
    errorSpan.textContent = message;
    errorSpan.classList.remove('hidden');
  }
}

function hideError(fieldId: string) {
  const errorSpan = form.querySelector(`[data-error="${fieldId}"]`) as HTMLSpanElement;
  if (errorSpan) {
    errorSpan.classList.add('hidden');
  }
}

function hideAllErrors() {
  const errorSpans = form.querySelectorAll('[data-error]');
  errorSpans.forEach(span => span.classList.add('hidden'));
}

function showFormError(message: string) {
  errorMessage.textContent = message;
  formError.classList.remove('hidden');
  formSuccess.classList.add('hidden');
}

function showFormSuccess() {
  formSuccess.classList.remove('hidden');
  formError.classList.add('hidden');
}

function hideFormMessages() {
  formError.classList.add('hidden');
  formSuccess.classList.add('hidden');
}

function validateForm(): boolean {
  hideAllErrors();
  hideFormMessages();
  let isValid = true;

  // Validate full name
  const fullName = (form.querySelector('#full-name') as HTMLInputElement).value.trim();
  if (!fullName) {
    showError('full-name', 'Le nom est requis');
    isValid = false;
  }

  // Validate email
  const email = (form.querySelector('#email') as HTMLInputElement).value.trim();
  if (!email) {
    showError('email', "L'email est requis");
    isValid = false;
  } else if (!validateEmail(email)) {
    showError('email', "L'email n'est pas valide");
    isValid = false;
  }

  // Validate consent
  const consent = (form.querySelector('#consent') as HTMLInputElement).checked;
  if (!consent) {
    showError('consent', 'Vous devez accepter la conservation de vos données');
    isValid = false;
  }

  return isValid;
}

// Handle form submission
form.addEventListener('submit', async (e) => {
  e.preventDefault();

  // Validate form
  if (!validateForm()) {
    return;
  }

  // Disable submit button and show loading state
  submitButton.disabled = true;
  const originalText = submitButton.textContent;
  submitButton.textContent = 'Envoi en cours...';

  try {
    // Prepare form data
    const formData = new FormData(form);
    const data: Record<string, any> = {};

    formData.forEach((value, key) => {
      if (key === 'consent' || key === 'newsletterConsent') {
        data[key] = value === 'on';
      } else {
        data[key] = value;
      }
    });

    // Try to get Botpoison solution with graceful fallback
    try {
      const solution = await getBotpoisonSolution();
      data._botpoison = solution;
      console.log('✓ Botpoison verification successful');
    } catch (error) {
      // Graceful fallback - allow submission without Botpoison
      console.warn('⚠️ Botpoison unavailable, submitting without bot protection:', error);
      data._botpoison = 'SERVICE_UNAVAILABLE';
      data._botpoison_error = error instanceof Error ? error.message : 'Unknown error';
      // Continue with submission - don't block users
    }

    // Submit form
    const response = await fetch(form.action, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      },
      body: JSON.stringify(data),
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));

      if (import.meta.env.DEV) {
        console.error('API Error:', {
          status: response.status,
          error: errorData
        });
      }

      throw new Error(
        errorData.error || `HTTP error! status: ${response.status}`
      );
    }

    // Show success message and reset form
    showFormSuccess();
    form.reset();

  } catch (error) {
    console.error('Form submission error:', error);
    showFormError(
      'Une erreur est survenue lors de l\'envoi. Veuillez réessayer plus tard.'
    );
  } finally {
    // Re-enable submit button
    submitButton.disabled = false;
    submitButton.textContent = originalText;
  }
});

// Add real-time validation for email
form.querySelector('#email')?.addEventListener('blur', (e) => {
  const email = (e.target as HTMLInputElement).value.trim();
  if (email && !validateEmail(email)) {
    showError('email', "L'email n'est pas valide");
  } else {
    hideError('email');
  }
});
</script>
